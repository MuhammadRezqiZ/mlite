<style>
    .btn-back{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 16px;
    border-radius:999px;
    background:linear-gradient(135deg,#ff4d4f 0%,#d9363e 100%);
    color:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,0.12);
    text-decoration:none;
    transition:all 0.3s ease;
  }
  .btn-back:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 24px rgba(0,0,0,0.15);
    filter:brightness(1.05);
    color:#fff;
  }
  
  /* Table Styles */
  .status-gudang {
    background-color: #fff !important;
    border-left: 4px solid #5bc0de !important; /* Info color */
  }
  .status-terdistribusi {
    background-color: #fff !important;
    border-left: 4px solid #5cb85c !important; /* Success color */
  }
  .table > tbody > tr > td {
      vertical-align: middle;
  }
  .btn-group-xs > .btn, .btn-xs {
      padding: 1px 5px;
      font-size: 12px;
      line-height: 1.5;
      border-radius: 3px;
  }
</style>
<div class="back" style="margin-bottom: 20px; text-align: right;">
  <a href="{?=url([ADMIN, 'asetkami', 'manage'])?}" class="btn-back"><i class="fa fa-arrow-left"></i>Kembali</a>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">{$data.title} <span class="badge" style="background-color: #337ab7; margin-left: 10px;">Total: {$data.total_aset}</span></h3>
            </div>
            <div class="panel-body">
                <!-- Filter Tanggal Pengadaan dan Kategori -->
                <div class="row" style="margin-bottom: 1px;">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="tanggal_dari">Dari:</label>
                            <input type="date" id="tanggal_dari" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="tanggal_ke">Ke:</label>
                            <input type="date" id="tanggal_ke" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="filter_kategori">Kategori:</label>
                            <select id="filter_kategori" class="form-control">
                                <option value="">Semua Kategori</option>
                                {loop: $data.kategori}
                                <option value="{$value.nm_kategori_barang}">{$value.nm_kategori_barang}</option>
                                {/loop}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="filter_asal_barang">Asal Barang:</label>
                            <select id="filter_asal_barang" class="form-control">
                                <option value="">Semua Asal Barang</option>
                                <option value="Pengadaan">Pengadaan</option>
                                <option value="Hibah">Hibah</option>
                                <option value="Bantuan">Bantuan</option>
                                <option value="Sumbangan">Sumbangan</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="filter_lokasi">Lokasi:</label>
                            <select id="filter_lokasi" class="form-control">
                                <option value="">Semua Lokasi</option>
                                <option value="Gudang">Gudang</option>
                                {loop: $data.unit_bidang}
                                <option value="{$value.nama_bidang} - {$value.nama_unit}">{$value.nama_bidang} - {$value.nama_unit}</option>
                                {/loop}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2" style="padding-top: 25px;">
                        <div class="btn-group">
                            <button type="button" id="btnFilter" class="btn btn-primary" title="Filter">
                                <i class="fa fa-filter"></i> Filter
                            </button>
                            <button type="button" id="btnReset" class="btn btn-default" title="Reset">
                                <i class="fa fa-refresh"></i> Reset
                            </button>
                            <button type="button" id="btnCetakPdf" class="btn btn-danger" title="Cetak PDF">
                                <i class="fa fa-file-pdf-o"></i> Pdf
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="dataTable">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Kode Distribusi</th>
                                <th>Tgl Pengadaan</th>
                                <th>Tgl Distribusi</th>
                                <th>Kategori</th>
                                <th>Sumber Dana</th>
                                <th>Asal Barang</th>
                                <th>Jenis</th>
                                <th>Merk</th>
                                <th>Model/Seri</th>
                                <th>SN</th>
                                <th>Lokasi</th>
                                <th>Petugas</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {if: $data.aset}
                            {loop: $data.aset}
                            <tr class="{if: $value.status == 'gudang'}status-gudang{else}status-terdistribusi{/if}">
                                <td>
                                    {if: $value.foto}
                                    <img src="{?=url()?}/uploads/aset/{$value.foto}" alt="Foto" style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;" class="img-thumbnail" onclick="showImage('{?=url()?}/uploads/aset/{$value.foto}')">
                                    {else}
                                    <span class="text-muted">Tidak ada foto</span>
                                    {/if}
                                </td>
                                <td>{$value.kd_distribusi}</td>
                                <td>{$value.tanggal_pengadaan}</td>
                                <td>
                                    {if: $value.tanggal_distribusi}
                                    {$value.tanggal_distribusi}
                                    {else}
                                    <span class="text-muted">-</span>
                                    {/if}
                                </td>
                                <td>{$value.nm_kategori_barang}</td>
                                <td>{$value.sumber_dana}</td>
                                <td>{$value.asal_barang}</td>
                                <td>{$value.nm_jns_barang}</td>
                                <td>{$value.merk}</td>
                                <td>{$value.model_seri}</td>
                                <td>{$value.sn}</td>
                            <td>
                                    {$value.lokasi}
                                </td>
                                
                                <td>
                                    {if: $value.petugas}
                                    {$value.petugas}
                                    {else}
                                    <span class="text-muted">-</span>
                                    {/if}
                                </td>
                                <td width="6%" class="text-center" style="white-space: nowrap;">
                                    <div class="btn-group btn-group-xs">
                                        {if: $value.status == 'terdistribusi'}
                                        <button type="button" class="btn btn-warning" onclick="pindahTangan('{$value.id}', '{$value.merk}', '{$value.model_seri}')" title="Pindah Tangan">
                                            <i class="fa fa-exchange"></i>
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="returnBarang('{$value.id}', '{$value.merk}', '{$value.model_seri}')" title="Return ke Gudang">
                                            <i class="fa fa-undo"></i>
                                        </button>
                                        {/if}
                                        <button type="button" class="btn btn-info" onclick="lihatRiwayat('{$value.kode_barang}', '{$value.merk}', '{$value.model_seri}')" title="Lihat Riwayat">
                                            <i class="fa fa-history"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {/loop}
                            {else}
                            <tr>
                                <td colspan="12" class="text-center">Tidak ada data aset</td>
                            </tr>
                            {/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Pindah Tangan -->
<div class="modal fade" id="pindahTanganModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Pindah Tangan Barang</h4>
            </div>
            <form id="formPindahTangan">
                <div class="modal-body">
                    <input type="hidden" id="barang_id" name="barang_id">
                    <div class="form-group">
                        <label>Barang:</label>
                        <input type="text" id="nama_barang" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Bidang:</label>
                        <select name="kode_bidang" id="kode_bidang" class="form-control" required>
                            <option value="">Pilih Bidang</option>
                            {loop: $data.bidang}
                            <option value="{$value.kode_bidang}">{$value.nama_bidang}</option>
                            {/loop}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unit Ruangan:</label>
                        <select name="kode_unit" id="kode_unit" class="form-control" required>
                            <option value="">Pilih Unit Ruangan</option>
                            {loop: $data.unit}
                            <option value="{$value.kode_unit}" data-bidang="{$value.kode_bidang}">{$value.nama_unit}</option>
                            {/loop}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Keterangan:</label>
                        <textarea name="keterangan" id="keterangan" class="form-control" rows="3" placeholder="Alasan pindah tangan..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-warning">Pindah Tangan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Return Barang -->
<div class="modal fade" id="returnBarangModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Return Barang ke Gudang</h4>
            </div>
            <form id="formReturnBarang">
                <div class="modal-body">
                    <input type="hidden" id="return_barang_id" name="barang_id">
                    <div class="form-group">
                        <label>Barang:</label>
                        <input type="text" id="return_nama_barang" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Keterangan Return:</label>
                        <textarea name="keterangan" id="return_keterangan" class="form-control" rows="3" placeholder="Alasan return ke gudang..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> Barang akan dikembalikan ke gudang dan status akan berubah menjadi tersedia.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Return ke Gudang</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Riwayat -->
<div class="modal fade" id="riwayatModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Riwayat Distribusi Barang</h4>
            </div>
            <div class="modal-body">
                <div id="riwayat-content">
                    <div class="text-center">
                        <i class="fa fa-spinner fa-spin"></i> Memuat riwayat...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="btnCetakRiwayat">
                    <i class="fa fa-print"></i> PDF
                </button>
                <button type="button" class="btn btn-warning" id="btnCetakBarcode">
                    <i class="fa fa-qrcode"></i>
                </button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<style>
.status-gudang {
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107 !important;
}

.status-terdistribusi {
    background-color: #d4edda !important;
    border-left: 4px solid #28a745 !important;
}

.status-gudang:hover {
    background-color: #ffeaa7 !important;
}

.status-terdistribusi:hover {
    background-color: #c3e6cb !important;
}
</style>

<script>
$(document).ready(function() {
    // Inisialisasi DataTable dengan variabel untuk akses global
    var table = $('#dataTable').DataTable({
        "language": {
            "url": "assets/jscripts/dataTables-id.json"
        },
        //"order": [[ 1, "desc" ]],
        "order": [], // Gunakan urutan dari query database (server-side)
        "pageLength": 25
    });
    
    // Custom search function untuk filter tanggal, kategori, dan asal barang
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            if (settings.nTable.id !== 'dataTable') {
                return true;
            }
            
            var tanggalDari = $('#tanggal_dari').val();
             var tanggalKe = $('#tanggal_ke').val();
             var filterKategori = $('#filter_kategori').val();
             var filterAsalBarang = $('#filter_asal_barang').val();
             var filterLokasi = $('#filter_lokasi').val();
             var tanggalData = data[2]; // Kolom tanggal pengadaan (index 2)
             var kategoriData = data[3]; // Kolom kategori (index 3)
             var asalBarangData = data[4]; // Kolom asal barang (index 4)
             var lokasiData = data[9]; // Kolom lokasi (index 9)
            
            // Filter kategori
            if (filterKategori && kategoriData !== filterKategori) {
                return false;
            }
            
            // Filter asal barang
            if (filterAsalBarang) {
                if (filterAsalBarang === 'Lainnya') {
                    // Tampilkan data yang asal barangnya bukan Pengadaan, Hibah, Bantuan, atau Sumbangan
                    if (asalBarangData === 'Pengadaan' || asalBarangData === 'Hibah' || asalBarangData === 'Bantuan' || asalBarangData === 'Sumbangan') {
                        return false;
                    }
                } else {
                    // Filter normal untuk pilihan spesifik
                    if (asalBarangData !== filterAsalBarang) {
                        return false;
                    }
                }
            }
            
            // Filter lokasi
            if (filterLokasi) {
                if (filterLokasi === 'Gudang') {
                    // Untuk filter Gudang, cek apakah lokasi mengandung kata "Gudang" atau kosong/null
                    if (lokasiData && lokasiData.toLowerCase().indexOf('gudang') === -1) {
                        return false;
                    }
                } else {
                    // Untuk filter unit/bidang, gunakan partial matching
                    if (!lokasiData || lokasiData.toLowerCase().indexOf(filterLokasi.toLowerCase()) === -1) {
                        return false;
                    }
                }
            }
            
            // Jika tidak ada filter tanggal, tampilkan data yang lolos filter kategori, asal barang, dan lokasi
            if (!tanggalDari && !tanggalKe) {
                return true;
            }
            
            // Skip jika tanggal kosong atau "-"
            if (!tanggalData || tanggalData === '-' || tanggalData.trim() === '') {
                return false;
            }
            
            // Konversi tanggal Indonesia (dd/mm/yyyy) ke format yang bisa diparsing
            var dateParts = tanggalData.split('/');
            if (dateParts.length !== 3) {
                return false;
            }
            
            // Format: dd/mm/yyyy -> yyyy-mm-dd
            var formattedDate = dateParts[2] + '-' + dateParts[1] + '-' + dateParts[0];
            var tanggalParsed = new Date(formattedDate);
            var filterDari = tanggalDari ? new Date(tanggalDari) : null;
            var filterKe = tanggalKe ? new Date(tanggalKe) : null;
            
            // Validasi tanggal
            if (isNaN(tanggalParsed.getTime())) {
                return false;
            }
            
            // Filter berdasarkan range tanggal
            if (filterDari && tanggalParsed < filterDari) {
                return false;
            }
            if (filterKe && tanggalParsed > filterKe) {
                return false;
            }
            
            return true;
        }
    );
    
    // Event handler untuk tombol filter
    $('#btnFilter').on('click', function() {
        table.draw();
    });
    
    // Event handler untuk tombol reset
    $('#btnReset').on('click', function() {
        $('#tanggal_dari').val('');
        $('#tanggal_ke').val('');
        $('#filter_kategori').val('');
        $('#filter_asal_barang').val('');
        $('#filter_lokasi').val('');
        table.draw();
    });
    
    // Auto filter saat input tanggal, kategori, asal barang, dan lokasi berubah
    $('#tanggal_dari, #tanggal_ke, #filter_kategori, #filter_asal_barang, #filter_lokasi').on('change', function() {
        table.draw();
    });
    
    // Event handler untuk tombol cetak PDF
    $('#btnCetakPdf').on('click', function() {
        var tanggalDari = $('#tanggal_dari').val();
        var tanggalKe = $('#tanggal_ke').val();
        var filterKategori = $('#filter_kategori').val();
        var filterAsalBarang = $('#filter_asal_barang').val();
        var filterLokasi = $('#filter_lokasi').val();
        
        var url = '{?=url(["asetkami","cetakpdf"])?}';
        var params = [];
        
        if (tanggalDari) {
            params.push('tanggal_dari=' + encodeURIComponent(tanggalDari));
        }
        if (tanggalKe) {
            params.push('tanggal_ke=' + encodeURIComponent(tanggalKe));
        }
        if (filterKategori) {
            params.push('kategori=' + encodeURIComponent(filterKategori));
        }
        if (filterAsalBarang) {
            // Kirim nilai filter asal barang termasuk "Lainnya"
            params.push('asal_barang=' + encodeURIComponent(filterAsalBarang));
        }
        if (filterLokasi) {
            params.push('lokasi=' + encodeURIComponent(filterLokasi));
        }
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        window.open(url, '_blank');
    });
    
    // Form submit pindah tangan
    $('#formPindahTangan').on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: '{?=url([ADMIN, "asetkami", "pindah_tangan"])?}',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            success: function(response) {
                if(response.status === 'success') {
                    alert('Barang berhasil dipindah tangan!');
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Terjadi kesalahan saat memproses permintaan.');
            }
        });
    });
    
    // Form submit return barang
    $('#formReturnBarang').on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: '{?=url([ADMIN, "asetkami", "return_barang"])?}',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            success: function(response) {
                if(response.status === 'success') {
                    alert('Barang berhasil dikembalikan ke gudang!');
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Terjadi kesalahan saat memproses permintaan.');
            }
        });
    });
    
    // Initialize selectator for dropdowns
    $('#kode_bidang, #kode_unit').selectator();
    
    // Event handler untuk dropdown bidang
    $('#kode_bidang').on('change', function() {
        var bidangValue = $(this).val();
        var unitSelect = $('#kode_unit');
        
        // Destroy selectator sebelum update
        unitSelect.selectator('destroy');
        
        // Reset dropdown
        unitSelect.find('option').hide();
        unitSelect.find('option:first').show(); // Show "Pilih Unit Ruangan" option
        unitSelect.val('');
        
        if (bidangValue) {
            // Show only units that match the selected bidang
            unitSelect.find('option[data-bidang="' + bidangValue + '"]').show();
        } else {
            // Show all units if no bidang selected
            unitSelect.find('option').show();
        }
        
        // Reinitialization selectator
        unitSelect.selectator();
    });
});

function pindahTangan(id, merk, model) {
    $('#barang_id').val(id);
    $('#nama_barang').val(merk + ' - ' + model);
    
    // Destroy selectator sebelum reset
    $('#kode_bidang').selectator('destroy');
    $('#kode_unit').selectator('destroy');
    
    // Reset nilai dropdown
    $('#kode_bidang').val('');
    $('#kode_unit').val('');
    
    // Reset unit dropdown - show all options
    $('#kode_unit option').show();
    $('#keterangan').val('');
    
    // Reinitialization selectator setelah reset
    $('#kode_bidang').selectator();
    $('#kode_unit').selectator();
    
    $('#pindahTanganModal').modal('show');
}

function returnBarang(id, merk, model) {
    $('#return_barang_id').val(id);
    $('#return_nama_barang').val(merk + ' - ' + model);
    $('#return_keterangan').val('');
    $('#returnBarangModal').modal('show');
}

var currentKodeBarang = '';

function lihatRiwayat(kode_barang, merk, model) {
    currentKodeBarang = kode_barang;
    $('#riwayatModal .modal-title').text('Riwayat Distribusi: ' + merk + ' - ' + model);
    $('#riwayat-content').html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Memuat riwayat...</div>');
    $('#riwayatModal').modal('show');
    
    $.ajax({
        url: '{?=url([ADMIN, "asetkami", "riwayat"])?}',
        type: 'GET',
        data: { kode_barang: kode_barang },
        success: function(response) {
            $('#riwayat-content').html(response);
        },
        error: function() {
            $('#riwayat-content').html('<div class="alert alert-danger">Gagal memuat riwayat distribusi.</div>');
        }
    });
}

// Event handler untuk tombol cetak PDF
$('#btnCetakRiwayat').on('click', function() {
    if (currentKodeBarang) {
        var url = '{?=url(["asetkami", "cetakriwayat"])?}?kode_barang=' + currentKodeBarang;
        window.open(url, '_blank');
    } else {
        alert('Kode barang tidak ditemukan!');
    }
});

// Function to show image in modal
function showImage(imageSrc) {
    $('#modalImage').attr('src', imageSrc);
    $('#imageModal').modal('show');
}

// Event handler untuk tombol cetak barcode
$('#btnCetakBarcode').on('click', function() {
    if (currentKodeBarang) {
        var url = '{?=url(["asetkami", "cetakbarcode"])?}?kode_barang=' + currentKodeBarang;
        window.open(url, '_blank');
    } else {
        alert('Kode barang tidak ditemukan!');
    }
});
</script>

<!-- Modal untuk menampilkan gambar -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Foto Barang</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="Foto Barang" style="max-width: 100%; height: auto;">
            </div>
        </div>
    </div>
</div>
