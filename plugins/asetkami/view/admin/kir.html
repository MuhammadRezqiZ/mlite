<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">KIR (Kartu Inventaris Aset)</h3>
            </div>

<!-- Modal Pengajuan Return Barang -->
<div class="modal fade" id="pengajuanReturnModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Form Pengajuan Pengembalian Barang</h4>
            </div>
            <form id="formPengajuanReturn" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="pengajuan_kd_distribusi" name="kd_distribusi">
                    <input type="hidden" id="pengajuan_kode_barang" name="kode_barang">
                    <div class="form-group">
                        <label>Nama Barang</label>
                        <input type="text" class="form-control" id="pengajuan_nama_barang" readonly>
                    </div>
                    <div class="form-group">
                        <label>Foto Barang</label>
                        <input type="file" class="form-control" name="foto" accept="image/*" required>
                    </div>
                    <div class="form-group">
                        <label>Kondisi Barang</label>
                        <select class="form-control" name="kondisi" required>
                            <option value="">-- Pilih Kondisi --</option>
                            <option value="Baik">Baik</option>
                            <option value="Rusak Ringan">Rusak Ringan</option>
                            <option value="Rusak Berat">Rusak Berat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Alasan Pengembalian</label>
                        <textarea class="form-control" name="alasan" rows="3" placeholder="Alasan pengembalian..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Ajukan Pengembalian</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function pengajuanReturnBarang(kd_distribusi, kode_barang, nama_barang) {
    $('#pengajuan_kd_distribusi').val(kd_distribusi);
    $('#pengajuan_kode_barang').val(kode_barang);
    $('#pengajuan_nama_barang').val(nama_barang);
    $('#pengajuanReturnModal').modal('show');
}

$('#formPengajuanReturn').on('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    
    $.ajax({
        url: '{?=url([ADMIN, "asetkami", "simpanPengajuan"])?}',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        dataType: 'json',
        success: function(response) {
            if (response.status == 'success') {
                alert(response.message);
                $('#pengajuanReturnModal').modal('hide');
                $('#formPengajuanReturn')[0].reset();
            } else {
                alert('Gagal: ' + (response.message || 'Tidak diketahui'));
            }
        },
        error: function(xhr) {
            alert('Terjadi kesalahan sistem: ' + xhr.status + ' ' + xhr.statusText);
            if (window.console && xhr.responseText) {
                console.error('Error pengajuan pengembalian:', xhr.responseText);
            }
        }
    });
});
</script>
            <div class="panel-body">
                <div class="row">
                    <!-- Form Filter di Kiri -->
                    <div class="col-md-4">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <h4 class="panel-title">Filter Data</h4>
                            </div>
                            <div class="panel-body">
                                <form id="kirForm">
                                    <div class="form-group">
                                        <label for="bidang">Bidang:</label>
                                        <select class="form-control" id="bidang" name="bidang" required>
                                            <option value="">-- Pilih Bidang --</option>
                                            {loop: $data.aset_bidang}
                                            <option value="{$value.kode_bidang}">{$value.nama_bidang}</option>
                                            {/loop}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="unit_ruangan">Unit/Ruangan:</label>
                                        <select class="form-control" id="unit_ruangan" name="unit_ruangan" required>
                                            <option value="">-- Pilih Unit/Ruangan --</option>
                                            {loop: $data.aset_unit}
                                            <option value="{$value.kode_unit}">{$value.nama_unit}</option>
                                            {/loop}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fa fa-search"></i> Cek Data Barang
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Info Panel -->
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">Informasi</h4>
                            </div>
                            <div class="panel-body">
                                <p><small class="text-muted">
                                    <i class="fa fa-info-circle"></i> 
                                    Pilih unit/ruangan untuk melihat data barang yang terdistribusi di lokasi tersebut.
                                </small></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hasil Tampilan Barang di Kanan -->
                    <div class="col-md-8">
                        <div class="panel panel-success">
                            <div class="panel-heading">
                                <h4 class="panel-title">Data Barang</h4>
                                <div class="panel-options">
                                    <span id="selectedLocation" class="label label-info">Belum ada lokasi dipilih</span>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div id="loadingIndicator" style="display: none; text-align: center; padding: 50px;">
                                    <i class="fa fa-spinner fa-spin fa-2x"></i>
                                    <p>Memuat data...</p>
                                </div>
                                
                                <div id="noDataMessage" style="text-align: center; padding: 50px; color: #999;">
                                    <i class="fa fa-inbox fa-3x"></i>
                                    <p>Silakan pilih unit/ruangan untuk melihat data barang</p>
                                </div>
                                
                                <div id="dataTable" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered" id="kirTable">
                                            <thead>
                                                <tr>
                                                    <th>Kode Distribusi</th>
                                                    <th>Kode Barang</th>
                                                    <th>Nama Barang</th>
                                                    <th>Merk</th>
                                                    <th>SN</th>
                                                    <th>Tanggal Distribusi</th>
                                                    <th>Keterangan</th>
                                                    <TH>Aksi</TH>
                                                </tr>
                                            </thead>
                                            <tbody id="kirTableBody">
                                                <!-- Data akan dimuat via AJAX -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="row" style="margin-top: 20px;">
                                        <div class="col-md-5">
                                            <div class="alert alert-info">
                                                <strong>Total Barang:</strong> <span id="totalBarang">0</span> item
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="alert alert-success">
                                                <strong>Total Nilai:</strong> <span id="totalNilai">Rp 0</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" id="cetakPdfBtn" class="btn btn-danger btn-block" style="display: none;">
                                                <i class="fa fa-file-pdf-o"></i> Cetak PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="unit_data_json">
{?=json_encode($data['aset_unit'])?}
</script>

<script>
$(document).ready(function() {
    var unitData = [];
    try {
        var rawData = document.getElementById('unit_data_json').textContent;
        unitData = JSON.parse(rawData);
    } catch (e) {
        console.error('Error parsing unit data:', e);
    }

    // Initialize selectator if available
    if ($.fn.selectator) {
        $('select').selectator();
    }

    // Filter Unit based on Bidang
    $('#bidang').change(function() {
        var selectedBidang = $(this).val();
        var unitSelect = $('#unit_ruangan');
        
        if ($.fn.selectator) {
            unitSelect.selectator('destroy');
        }
        
        unitSelect.empty();
        unitSelect.append('<option value="">-- Pilih Unit/Ruangan --</option>');
        
        if (selectedBidang) {
            var filteredUnits = unitData.filter(function(unit) {
                return unit.kode_bidang == selectedBidang;
            });
            
            $.each(filteredUnits, function(index, unit) {
                unitSelect.append('<option value="' + unit.kode_unit + '">' + unit.nama_unit + '</option>');
            });
        } else {
            // Show all units if no bidang selected
            $.each(unitData, function(index, unit) {
                unitSelect.append('<option value="' + unit.kode_unit + '">' + unit.nama_unit + '</option>');
            });
        }
        
        if ($.fn.selectator) {
            unitSelect.selectator();
        }
    });

    // Handle form submission
    $('#kirForm').submit(function(e) {
        e.preventDefault();
        
        var bidang = $('#bidang').val();
        var unitRuangan = $('#unit_ruangan').val();
        var bidangText = $('#bidang option:selected').text();
        var unitText = $('#unit_ruangan option:selected').text();
        
        if (!bidang || !unitRuangan) {
            alert('Silakan pilih bidang dan unit/ruangan terlebih dahulu!');
            return;
        }
        
        // Update location display
        $('#selectedLocation').text(bidangText + ' - ' + unitText);
        
        // Show loading
        $('#loadingIndicator').show();
        $('#noDataMessage').hide();
        $('#dataTable').hide();
        
        // Load data
        $.ajax({
            url: '{?=url([ADMIN, "asetkami", "kirdata"])?}',
            type: 'GET',
            data: {
                kode_bidang: bidang,
                kode_unit: unitRuangan
            },
            dataType: 'json',
            success: function(data) {
                $('#loadingIndicator').hide();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                if (data.length === 0) {
                    $('#noDataMessage').html('<i class="fa fa-inbox fa-3x"></i><p>Tidak ada barang di lokasi ini</p>').show();
                } else {
                    populateTable(data);
                    $('#dataTable').show();
                }
            },
            error: function() {
                $('#loadingIndicator').hide();
                alert('Terjadi kesalahan saat memuat data');
            }
        });
    });
    
    function populateTable(data) {
        var tbody = $('#kirTableBody');
        tbody.empty();
        
        var totalNilai = 0;
        
        $.each(data, function(index, item) {
            var row = '<tr>' +
                '<td>' + item.kd_distribusi + '</td>' +
                '<td>' + item.kode_barang + '</td>' +
                '<td>' + item.nm_jns_barang + '</td>' +
                '<td>' + (item.merk || '-') + '</td>' +
                '<td>' + (item.sn || '-') + '</td>' +
                '<td>' + item.tanggal_distribusi + '</td>' +
                '<td>' + item.keterangan + '</td>' +
                '<td>' + item.aksi + '</td>' +
                '</tr>';
            tbody.append(row);
            
            totalNilai += parseFloat(item.harga) || 0;
        });
        
        // Update summary
        $('#totalBarang').text(data.length);
        $('#totalNilai').text('Rp ' + totalNilai.toLocaleString('id-ID'));
        
        // Show cetak PDF button when data is loaded
        $('#cetakPdfBtn').show();
        
        // Initialize DataTable if not already initialized
        if (!$.fn.DataTable.isDataTable('#kirTable')) {
            $('#kirTable').DataTable({
                "pageLength": 10,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Indonesian.json"
                }
            });
        } else {
            $('#kirTable').DataTable().destroy();
            $('#kirTable').DataTable({
                "pageLength": 10,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Indonesian.json"
                }
            });
        }
    }
    
    function resetDisplay() {
        $('#selectedLocation').text('Belum ada lokasi dipilih');
        $('#loadingIndicator').hide();
        $('#dataTable').hide();
        $('#cetakPdfBtn').hide();
        $('#noDataMessage').html('<i class="fa fa-inbox fa-3x"></i><p>Silakan pilih bidang dan unit/ruangan untuk melihat data barang</p>').show();
    }
    
    // Handle cetak PDF button click
    $('#cetakPdfBtn').click(function() {
        var bidang = $('#bidang').val();
        var unitRuangan = $('#unit_ruangan').val();
        
        if (!bidang || !unitRuangan) {
            alert('Silakan pilih bidang dan unit/ruangan terlebih dahulu!');
            return;
        }
        
        // Open PDF in new window
        var url = '{?=url()?}/asetkami/cetakkir?kode_bidang=' + encodeURIComponent(bidang) + '&kode_unit=' + encodeURIComponent(unitRuangan);
        window.open(url, '_blank');
    });

    // Handle form submit return barang
    $('#formReturnBarang').on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: '{?=url([ADMIN, "asetkami", "return_barang"])?}',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            success: function(response) {
                if(response.status === 'success') {
                    alert('Barang berhasil dikembalikan ke gudang!');
                    $('#returnBarangModal').modal('hide');
                    // Reload data
                    $('#kirForm').submit();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Terjadi kesalahan saat memproses permintaan.');
            }
        });
    });
});

function returnBarang(id, merk, model) {
    $('#return_barang_id').val(id);
    $('#return_nama_barang').val(merk + ' - ' + model);
    $('#return_keterangan').val('');
    $('#returnBarangModal').modal('show');
}

</script>

<style>
.panel-options {
    float: right;
    margin-top: -5px;
}

#kirTable {
    font-size: 12px;
}

#kirTable th {
    background-color: #f5f5f5;
    font-weight: bold;
    text-align: center;
    vertical-align: middle;
}

#kirTable td {
    vertical-align: middle;
}

.alert {
    margin-bottom: 0;
    text-align: center;
}

.fa-spin {
    color: #337ab7;
}
</style>

<!-- Modal Return Barang -->
<div class="modal fade" id="returnBarangModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Kembalikan ke Gudang Aset Bekas</h4>
            </div>
            <form id="formReturnBarang">
                <div class="modal-body">
                    <input type="hidden" id="return_barang_id" name="barang_id">
                    <div class="form-group">
                        <label>Nama Barang</label>
                        <input type="text" class="form-control" id="return_nama_barang" readonly>
                    </div>
                    <div class="form-group">
                        <label>Keterangan Pengembalian</label>
                        <textarea class="form-control" id="return_keterangan" name="keterangan" rows="3" placeholder="Alasan pengembalian..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fa fa-warning"></i> Barang akan dikembalikan ke Gudang (Status: Aset Bekas) dan stok akan bertambah.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-warning">Kembalikan Barang</button>
                </div>
            </form>
        </div>
    </div>
</div>
