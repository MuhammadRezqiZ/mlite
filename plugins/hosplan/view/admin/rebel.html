<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style media="screen">
  .modern-stat-card {
    border-radius: 12px;
    padding: 15px;
    color:white;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
  }
  
  .modern-stat-card.rebel {
    background: linear-gradient(135deg, #4CAF50 0%, #338937 100%);
  }
  
  .modern-stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.18);
  }
  
  .modern-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    pointer-events: none;
  }
  .highlight-new {
    background-color: #e8ffe8 !important;
    transition: background-color 2s ease-in-out;
  }
  .btn-back{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 16px;
    border-radius:999px;
    background:linear-gradient(135deg,#ff4d4f 0%,#d9363e 100%);
    color:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,0.12);
    text-decoration:none;
    transition:all 0.3s ease;
  }
  .btn-back:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 24px rgba(0,0,0,0.15);
    filter:brightness(1.05);
    color:#fff;
  }
</style>

<div class="back" style="margin-bottom: 20px; text-align: right;">
  <a href="{?=url([ADMIN, 'hosplan', 'manage'])?}" class="btn-back"><i class="fa fa-arrow-left"></i>Kembali</a>
</div>

<div class="col-lg-3 col-md-6" style="margin-bottom: 40px;">
        <div class="modern-stat-card rebel">
            <div style="margin-bottom: 15px;">
                <div class="row">
                    <div class="col-xs-3">
                        <i class="fa fa-archive fa-5x" style="opacity: 0.8;"></i>
                    </div>
                    <div class="col-xs-9 text-right" style="font-size: 16px; margin-top: 10px; color: white;">
                        <div class="huge" id="kas-masuk" style="font-size: 3rem; font-weight: 700; line-height: 1;">0</div>
                        <div style="opacity: 0.9;">Jumlah Rebel</div>
                    </div>
                </div>
            </div>
            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 10px;">
                <span class="pull-left" style="font-size: 0.9rem; opacity: 0.9;">Total Rebel Terkini</span>
                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>

<div class="row" style="margin-bottom: 20px;">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-clock-o"></i> &nbsp; Data Realisasi Belanja RSUD H. Damanhuri Barabai
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table id="tabelSuratUsulan" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Kode Akun</th>
                                <th style="text-align: center;">Uraian Kegiatan</th>
                                <th style="text-align: center;">Januari</th>
                                <th style="text-align: center;">Februari</th>
                                <th style="text-align: center;">Maret</th>
                                <th style="text-align: center;">April</th>
                                <th style="text-align: center;">Mei</th>
                                <th style="text-align: center;">Juni</th>
                                <th style="text-align: center;">Juli</th>
                                <th style="text-align: center;">Agustus</th>
                                <th style="text-align: center;">September</th>
                                <th style="text-align: center;">Oktober</th>
                                <th style="text-align: center;">November</th>
                                <th style="text-align: center;">Desember</th>
                                <th style="text-align: center;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data akan ditampilkan setelah filter unit dipilih -->
                            {loop: $tabel_rebel}
                            <tr>
                                <td>{$value.kode_akun}</td>
                                <td>{$value.uraian_kegiatan}</td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="januari" value="{?=number_format($value['januari'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="februari" value="{?=number_format($value['februari'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="maret" value="{?=number_format($value['maret'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="april" value="{?=number_format($value['april'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="mei" value="{?=number_format($value['mei'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="juni" value="{?=number_format($value['juni'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="juli" value="{?=number_format($value['juli'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="agustus" value="{?=number_format($value['agustus'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="september" value="{?=number_format($value['september'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="oktober" value="{?=number_format($value['oktober'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="november" value="{?=number_format($value['november'], 0, ',', '.')?}"></td>
                                <td><input type="text" class="rebel-input" data-id="{$value.id_rebel}" data-field="desember" value="{?=number_format($value['desember'], 0, ',', '.')?}"></td>
                                <td class="total-cell" style="text-align:right;">
                                    {?= number_format(
                                        $value['januari'] + $value['februari'] + $value['maret'] + 
                                        $value['april'] + $value['mei'] + $value['juni'] + 
                                        $value['juli'] + $value['agustus'] + $value['september'] + 
                                        $value['oktober'] + $value['november'] + $value['desember']
                                    , 0, ',', '.') ?}
                                </td>
                            </tr>
                            {/loop}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
$(document).ready(function() {
  var table;
  if ($.fn.dataTable.isDataTable('#tabelSuratUsulan')) {
    table = $('#tabelSuratUsulan').DataTable();
  } else {
    table = $('#tabelSuratUsulan').DataTable({
    "pageLength": 150, // default show 10 entries
    "lengthMenu": [ [10, 25, 50, 100, 150, -1], [10, 25, 50, 100, 150, "All"] ],
    "order": [[0, 'asc']], // tampilkan data terbaru (id terbesar) di atas
    "language": {
      "lengthMenu": "Tampilkan _MENU_ data per halaman",
      "zeroRecords": "Silakan pilih unit terlebih dahulu untuk melihat data",
      "info": "Menampilkan halaman _PAGE_ dari _PAGES_",
      "infoEmpty": "Tidak ada data tersedia",
      "infoFiltered": "(disaring dari total _MAX_ data)",
      "search": "Cari:",
      "paginate": {
        "first": "Pertama",
        "last": "Terakhir",
        "next": "›",
        "previous": "‹"
      }
    }
  });
  }

  // Utility notifikasi dengan fallback jika SweetAlert2 tidak tersedia
  function showNotification(type, message) {
    var iconMap = { success: 'success', warning: 'warning', danger: 'error', error: 'error', info: 'info' };
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: iconMap[type] || 'info',
        title: message,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
      });
    } else {
      // Fallback sederhana jika SweetAlert2 tidak termuat
      alert(message);
    }
  }

  // Tampilkan notifikasi berdasarkan parameter URL
  const params = new URLSearchParams(window.location.search);
  if (params.get('added') === '1') {
    showNotification('success', 'Data berhasil ditambahkan!');
    // Sorot baris teratas sebagai indikasi data baru
    const firstRow = $(table.row(0).node());
    firstRow.addClass('highlight-new');
    setTimeout(() => firstRow.removeClass('highlight-new'), 2500);
  }
  if (params.get('edited') === '1') {
    showNotification('warning', 'Data berhasil diperbarui!');
  }
  if (params.get('deleted') === '1') {
    showNotification('error', 'Data berhasil dihapus!');
  }

  // Hapus parameter notifikasi dari URL agar tidak muncul lagi saat refresh
  if (params.has('added') || params.has('edited') || params.has('deleted')) {
    params.delete('added');
    params.delete('edited');
    params.delete('deleted');
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.replaceState({}, '', newUrl);
  }

  // Fungsi untuk update jumlah usulan RKA
  function updateRkaCount() {
    var rowCount = table.rows({ 'search': 'applied' }).nodes().length;
    $('#kas-masuk').text(rowCount);
  }

  // Panggil fungsi saat tabel selesai diinisialisasi
  updateRkaCount();

  // Panggil fungsi setiap kali tabel digambar ulang (termasuk saat filtering, paginasi, atau search)
  table.on('draw', function() {
    updateRkaCount();
  });

  $('#tabelSuratUsulan').on('click', '.btn-hapus', function(e) {
        e.preventDefault();
        var url = $(this).attr('href');
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Anda yakin?',
            text: "Data yang dihapus tidak dapat dikembalikan!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, hapus!',
            cancelButtonText: 'Batal'
          }).then((result) => {
              if (result.isConfirmed) {
                  window.location.href = url;
              }
          });
        } else {
          // Fallback ke konfirmasi native
          if (confirm('Yakin ingin menghapus usulan RKA ini?')) {
            window.location.href = url;
          }
        }
    });

  // Utility to parse formatted number
  function parseLocaleNumber(stringNumber) {
    if (!stringNumber) return 0;
    // Remove dots (thousands separator) and replace comma with dot if decimal (though here it seems to be integer)
    var cleaned = stringNumber.toString().replace(/\./g, ''); 
    return parseFloat(cleaned) || 0;
  }

  // Utility to format number
  function formatLocaleNumber(number) {
    return new Intl.NumberFormat('id-ID').format(number);
  }

  // Function to update row total
  function updateRowTotal(row) {
    var total = 0;
    row.find('.rebel-input').each(function() {
        total += parseLocaleNumber($(this).val());
    });
    row.find('.total-cell').text(formatLocaleNumber(total));
  }

  // Excel-like editing
  $('#tabelSuratUsulan').on('focus', '.rebel-input', function() {
    $(this).parent().css('background-color', '#fff');
    $(this).select(); // Auto select content on focus
  });

  $('#tabelSuratUsulan').on('input', '.rebel-input', function() {
     // Recalculate total on input change
     var row = $(this).closest('tr');
     updateRowTotal(row);
  });

  $('#tabelSuratUsulan').on('blur', '.rebel-input', function() {
    $(this).parent().css('background-color', 'transparent');
    
    var input = $(this);
    var id = input.data('id');
    var field = input.data('field');
    var value = input.val();
    var originalValue = input.prop('defaultValue');

    // Only save if changed
    if (value !== originalValue) {
        // Show saving state (e.g. text color blue)
        input.css('color', 'blue');

        // Format the input value for display
        var numericValue = parseLocaleNumber(value);
        var formattedValue = formatLocaleNumber(numericValue);
        // Only update input value if it's a valid number
        if (!isNaN(numericValue)) {
            input.val(formattedValue);
            // Update value variable for AJAX (though backend cleans it anyway, sending formatted is fine)
            value = formattedValue; 
        }

        $.post("{?=url([ADMIN, 'hosplan', 'ajaxupdaterebel'])?}", {
            id: id,
            field: field,
            value: value
        }, function(response) {
            try {
                var res = JSON.parse(response);
                if(res.status === 'success') {
                    input.css('color', 'green'); 
                    input.prop('defaultValue', value); // Update default value
                    setTimeout(function(){ input.css('color', ''); }, 1000);
                    showNotification('success', 'Data tersimpan');
                    // Ensure total is correct after formatting (should be same, but good measure)
                    updateRowTotal(input.closest('tr'));
                } else {
                    input.css('color', 'red');
                    showNotification('error', 'Gagal: ' + res.message);
                }
            } catch(e) {
                input.css('color', 'red');
                console.error('Invalid response', response);
            }
        }).fail(function() {
            input.css('color', 'red');
            showNotification('error', 'Koneksi gagal');
        });
    } else {
        // If not changed but just blurred, maybe reformat ensuring it's consistent
        var numericValue = parseLocaleNumber(value);
        if (!isNaN(numericValue)) {
             input.val(formatLocaleNumber(numericValue));
        }
    }
  });

  // Enter key to save (trigger blur)
   $('#tabelSuratUsulan').on('keypress', '.rebel-input', function(e) {
     if(e.which == 13) {
         $(this).blur();
         return false; 
     }
   });

   // Arrow key navigation
   $('#tabelSuratUsulan').on('keydown', '.rebel-input', function(e) {
     var td = $(this).parent();
     var tr = td.parent();
     var index = td.index();
     
     if (e.which == 37) { // Left
         var prev = td.prev().find('.rebel-input');
         if(prev.length) {
            e.preventDefault();
            prev.focus();
         }
     } else if (e.which == 38) { // Up
         var prevRow = tr.prev();
         if(prevRow.length) {
            e.preventDefault();
            prevRow.find('td').eq(index).find('.rebel-input').focus();
         }
     } else if (e.which == 39) { // Right
         var next = td.next().find('.rebel-input');
         if(next.length) {
            e.preventDefault();
            next.focus();
         }
     } else if (e.which == 40) { // Down
         var nextRow = tr.next();
         if(nextRow.length) {
            e.preventDefault();
            nextRow.find('td').eq(index).find('.rebel-input').focus();
         }
     }
   });
 });

</script>


