<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
/>
<link
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
  rel="stylesheet"
/>
<!-- jQuery dihapus karena sudah ada di theme admin -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style media="screen">
  .modern-stat-card {
    border-radius: 12px;
    padding: 15px;
    color: white;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
  }

  .modern-stat-card.usulan {
    background: linear-gradient(135deg, #4caf50 0%, #338937 100%);
  }

  .modern-stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.18);
  }

  .modern-stat-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      45deg,
      rgba(255, 255, 255, 0.1) 0%,
      transparent 100%
    );
    pointer-events: none;
  }
  .highlight-new {
    background-color: #e8ffe8 !important;
    transition: background-color 2s ease-in-out;
  }
  /* Pastikan Select2 melebar mengikuti container */
  .select2-container {
    width: 100% !important;
  }
  .btn-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 999px;
    background: linear-gradient(135deg, #ff4d4f 0%, #d9363e 100%);
    color: #fff;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .btn-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.15);
    filter: brightness(1.05);
    color: #fff;
  }
  @media (min-width: 992px) {
    .modal-xl {
      width: 90%;
      max-width: 1200px;
    }
  }

  /* Enhanced Table & Text Truncation */
  .cell-text-limit {
    max-width: 220px;
    display: -webkit-box;
    --webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    font-size: 0.9em;
    color: #555;
    margin-top: 2px;
  }
  .table-modern thead th {
    background: linear-gradient(135deg, #0056b3 0%, #004494 100%);
    color: white;
    vertical-align: middle;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 1.1rem;
    letter-spacing: 0.5px;
    padding: 15px;
  }
  .table-modern tbody td {
    vertical-align: top;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
  }
  .table-modern tbody tr:hover {
    background-color: #f8faff !important;
  }
  .btn-icon-action {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    margin: 0 3px;
    color: white;
    border: none;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
  }
  .btn-icon-action:hover {
    transform: translateY(-3px);
    color: white;
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
  }
  .bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
  }
  .bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  }
  .bg-gradient-danger {
    background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
  }
</style>

<div class="back" style="margin-bottom: 20px; text-align: right">
  <a href="{?=url([ADMIN, 'hosplan', 'surat'])?}" class="btn-back"
    ><i class="fa fa-arrow-left"></i>Kembali</a
  >
</div>

<div class="col-lg-3 col-md-6" style="margin-bottom: 40px">
  <div class="modern-stat-card usulan">
    <div class="panel-heading">
      <div class="row">
        <div class="col-xs-3">
          <i class="fa fa-archive fa-5x"></i>
        </div>
        <div
          class="col-xs-9 text-right"
          style="font-size: 16px; margin-top: 20px"
        >
          <div class="huge" id="telaahan-count">0</div>
          <div>Jumlah Surat Telaahan</div>
        </div>
      </div>
    </div>
    <div class="">
      <span class="pull-left">Total Surat Telaahan Terkini</span>
      <span class="pull-right"><i class="fa fa-archive"></i></span>
      <div class="clearfix"></div>
    </div>
  </div>
</div>

<div class="row" style="margin-bottom: 20px">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading" style="font-size: large">
        <i class="fa fa-archive"></i> &nbsp;
        <b>Data Surat Telaahan RSUD H. Damanhuri Barabai</b>
      </div>
      <div class="panel-body">
        <div class="table-responsive">
          <!-- Filter Unit -->
          <style>
            .filter-card {
              background: #fff;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              padding: 12px 14px;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
              margin-bottom: 12px;
            }
            .filter-row {
              display: flex;
              align-items: center;
              gap: 12px;
            }
            .filter-select {
              flex: 1 1 auto;
              min-width: 280px;
            }
            .btn-pilih {
              background: #111;
              color: #fff;
              border-color: #111;
            }
            .btn-pilih:hover {
              background: #000;
              color: #fff;
            }
          </style>

          <div
            class="btn-toolbar"
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              flex-wrap: wrap;
              margin-bottom: 14px;
            "
          >
            <button
              type="button"
              class="btn btn-primary btn-sm"
              data-toggle="modal"
              data-target="#telaahanModal"
            >
              <i class="fa fa-plus mr-1"></i>&nbsp; Tambah Surat Telaahan
            </button>
          </div>
          <form
            id="formCetakTelaahan"
            action="{?= url([ADMIN, 'hosplan', 'cetaksurattelaahan']) ?}"
            method="post"
          >
            <input type="hidden" name="t" value="{?=$_GET['t']?}" />

            <table
              id="tabelSuratTelaahan"
              class="table table-modern"
              style="width: 100%; border-collapse: separate; border-spacing: 0"
            >
              <thead>
                <tr>
                  <th
                    class="text-center"
                    width="5%"
                    style="border-radius: 10px 0 0 10px"
                  >
                    No.
                  </th>
                  <th width="12%">Detail Surat</th>
                  <th width="21%">Masalah & Pra-Anggapan</th>
                  <th width="21%">Fakta & Pembahasan</th>
                  <th width="21%">Saran & Penutup</th>
                  <th class="text-center" width="10%">Unit</th>
                  <th
                    class="text-center"
                    width="10%"
                    style="border-radius: 0 10px 10px 0"
                  >
                    Aksi
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- Data akan ditampilkan setelah filter unit dipilih -->
                {loop: $tabel_surattelaahan}
                <tr>
                  <td
                    class="text-center font-weight-bold"
                    style="padding-top: 20px"
                    data-order="{$value.id_surat}"
                  >
                    {$value.no_surat}
                  </td>
                  <td>
                    <div
                      style="
                        font-weight: 700;
                        color: #333;
                        margin-bottom: 5px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                      "
                    >
                      <i class="fa fa-calendar text-primary"></i>
                      {$value.tgl_surat}
                    </div>
                    <div
                      class="text-muted small"
                      style="line-height: 1.3; font-style: italic"
                    >
                      {$value.perihal}
                    </div>
                  </td>
                  <td>
                    <div style="margin-bottom: 12px">
                      <strong
                        style="
                          font-size: 0.8em;
                          color: #0056b3;
                          letter-spacing: 0.5px;
                          text-transform: uppercase;
                        "
                        >Permasalahan</strong
                      >
                      <div
                        class="cell-text-limit"
                        title="{$value.permasalahan}"
                      >
                        {$value.permasalahan}
                      </div>
                    </div>
                    <div>
                      <strong
                        style="
                          font-size: 0.8em;
                          color: #0056b3;
                          letter-spacing: 0.5px;
                          text-transform: uppercase;
                        "
                        >Pra-Anggapan</strong
                      >
                      <div
                        class="cell-text-limit"
                        title="{$value.pra_anggapan}"
                      >
                        {$value.pra_anggapan}
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="margin-bottom: 12px">
                      <strong
                        style="
                          font-size: 0.8em;
                          color: #0056b3;
                          letter-spacing: 0.5px;
                          text-transform: uppercase;
                        "
                        >Fakta-Fakta</strong
                      >
                      <div class="cell-text-limit" title="{$value.fakta}">
                        {$value.fakta}
                      </div>
                    </div>
                    <div>
                      <strong
                        style="
                          font-size: 0.8em;
                          color: #0056b3;
                          letter-spacing: 0.5px;
                          text-transform: uppercase;
                        "
                        >Pembahasan</strong
                      >
                      <div class="cell-text-limit" title="{$value.pembahasan}">
                        {$value.pembahasan}
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="margin-bottom: 12px">
                      <strong
                        style="
                          font-size: 0.8em;
                          color: #0056b3;
                          letter-spacing: 0.5px;
                          text-transform: uppercase;
                        "
                        >Saran Tindakan</strong
                      >
                      <div
                        class="cell-text-limit"
                        title="{$value.saran_tindakan}"
                      >
                        {$value.saran_tindakan}
                      </div>
                    </div>
                    <div>
                      <strong
                        style="
                          font-size: 0.8em;
                          color: #0056b3;
                          letter-spacing: 0.5px;
                          text-transform: uppercase;
                        "
                        >Penutup</strong
                      >
                      <div class="cell-text-limit" title="{$value.penutup}">
                        {$value.penutup}
                      </div>
                    </div>
                  </td>
                  <td class="text-center" style="padding-top: 20px">
                    <span
                      class="badge"
                      style="
                        background: #e9ecef;
                        color: #495057;
                        font-weight: 600;
                        padding: 8px 12px;
                        border-radius: 6px;
                        border: 1px solid #dee2e6;
                      "
                    >
                      {$value.nama_unit}
                    </span>
                  </td>
                  <td class="text-center" style="padding-top: 15px">
                    <div style="display: flex; justify-content: center">
                      <a
                        href="{?= url([ADMIN, 'hosplan', 'cetaksurattelaahan', $value['id_surat']])?}"
                        target="_blank"
                        class="btn-icon-action bg-gradient-info"
                        title="Cetak"
                        data-toggle="tooltip"
                        ><i class="fa fa-print"></i
                      ></a>
                      <button
                        type="button"
                        class="btn-icon-action bg-gradient-success edit-btn"
                        data-json="{$value.json_data}"
                      >
                        <i class="fa fa-pencil"></i>
                      </button>
                      <a
                        href="{?= url([ADMIN, 'hosplan', 'deletesurattelaahan', $value['id_surat']])?}"
                        class="btn-icon-action bg-gradient-danger btn-hapus"
                        title="Hapus"
                        data-toggle="tooltip"
                        ><i class="fa fa-trash"></i
                      ></a>
                    </div>
                  </td>
                </tr>
                {/loop}
              </tbody>
            </table>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="telaahanModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div
      class="modal-content"
      style="
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      "
    >
      <form
        method="post"
        action="{?=url([ADMIN, 'hosplan', 'tambahsurattelaahan'])?}"
        id="telaahanForm"
      >
        <input type="hidden" name="id_surat" id="id_surat_input" />
        <div
          class="modal-header"
          style="
            background: linear-gradient(135deg, #0056b3 0%, #004494 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px;
          "
        >
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            style="color: white; opacity: 1"
          >
            &times;
          </button>
          <h4
            class="modal-title"
            id="telaahanModalTitle"
            style="font-weight: 600"
          >
            <i class="fa fa-pencil-square-o" style="color:#fff;"></i>
            <span style="color: #fff">Tambah Surat Telaahan</span>
          </h4>
        </div>

        <div
          class="modal-body"
          style="padding: 25px; background-color: #f8f9fa"
        >
          <!-- Row 1: No Surat & Tanggal -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="no_surat" style="font-weight: 600; color: #495057"
                  >Nomor Surat</label
                >
                <div class="input-group">
                  <span
                    class="input-group-addon"
                    style="background-color: #fff; border-right: 0"
                    ><i class="fa fa-hashtag text-primary"></i
                  ></span>
                  <input
                    id="no_surat"
                    type="text"
                    class="form-control"
                    name="no_surat"
                    placeholder="Contoh: 001/RSHD/2025"
                    style="border-left: 0"
                    required
                  />
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="tgl_surat" style="font-weight: 600; color: #495057"
                  >Tanggal Surat</label
                >
                <div class="input-group">
                  <span
                    class="input-group-addon"
                    style="background-color: #fff; border-right: 0"
                    ><i class="fa fa-calendar text-primary"></i
                  ></span>
                  <input
                    id="tgl_surat"
                    type="date"
                    class="form-control"
                    name="tgl_surat"
                    style="border-left: 0"
                    required
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Row 2: Perihal -->
          <div class="form-group">
            <label for="perihal" style="font-weight: 600; color: #495057"
              >Perihal Surat</label
            >
            <div class="input-group">
              <span
                class="input-group-addon"
                style="background-color: #fff; border-right: 0"
                ><i class="fa fa-envelope-o text-primary"></i
              ></span>
              <input
                id="perihal"
                type="text"
                class="form-control"
                name="perihal"
                placeholder="Perihal utama surat telaahan..."
                style="border-left: 0"
                required
              />
            </div>
          </div>

          <!-- Row 3: Permasalahan & Pra Anggapan -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label
                  for="permasalahan"
                  style="font-weight: 600; color: #495057"
                  >Permasalahan</label
                >
                <textarea
                  id="permasalahan"
                  class="form-control"
                  name="permasalahan"
                  rows="3"
                  placeholder="Uraikan permasalahan..."
                  style="resize: vertical"
                  required
                ></textarea>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label
                  for="pra_anggapan"
                  style="font-weight: 600; color: #495057"
                  >Pra Anggapan</label
                >
                <textarea
                  id="pra_anggapan"
                  class="form-control"
                  name="pra_anggapan"
                  rows="3"
                  placeholder="Pra anggapan terkait masalah..."
                  style="resize: vertical"
                  required
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Row 4: Fakta & Pembahasan -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="fakta" style="font-weight: 600; color: #495057"
                  >Fakta-Fakta</label
                >
                <textarea
                  id="fakta"
                  class="form-control"
                  name="fakta"
                  rows="3"
                  placeholder="Fakta-fakta di lapangan..."
                  style="resize: vertical"
                  required
                ></textarea>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="pembahasan" style="font-weight: 600; color: #495057"
                  >Pembahasan</label
                >
                <textarea
                  id="pembahasan"
                  class="form-control"
                  name="pembahasan"
                  rows="3"
                  placeholder="Analisis dan pembahasan..."
                  style="resize: vertical"
                  required
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Row 5: Saran Tindakan & Penutup -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label
                  for="saran_tindakan"
                  style="font-weight: 600; color: #495057"
                  >Saran Tindakan</label
                >
                <textarea
                  id="saran_tindakan"
                  class="form-control"
                  name="saran_tindakan"
                  rows="3"
                  placeholder="Rekomendasi tindakan..."
                  style="resize: vertical"
                  required
                ></textarea>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="penutup" style="font-weight: 600; color: #495057"
                  >Penutup</label
                >
                <textarea
                  id="penutup"
                  class="form-control"
                  name="penutup"
                  rows="3"
                  placeholder="Kalimat penutup..."
                  style="resize: vertical"
                  required
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Row 6: Unit -->
          <div class="form-group">
            <label for="id_unit_modal" style="font-weight: 600; color: #495057"
            >Unit</label>
            <select
              id="id_unit_modal"
              class="form-control"
              name="id_unit"
              required
            >
            <option value="">-- Pilih Unit --</option>
              {loop: $unit}
              <option value="{$value.id_unit}">{?= $value['nama_unit'] ?}</option>
              {/loop}
            </select>
          </div>
        </div>

        <div
          class="modal-footer"
          style="
            border-top: 1px solid #e9ecef;
            padding: 15px;
            background-color: #fff;
            border-radius: 0 0 15px 15px;
          "
        >
          <button
            type="button"
            class="btn btn-default btn-sm pull-left"
            data-dismiss="modal"
            style="border-radius: 6px"
          >
            <i class="fa fa-times"></i> Batal
          </button>
          <button
            type="submit"
            class="btn btn-primary btn-sm"
            style="
              border-radius: 6px;
              padding-left: 20px;
              padding-right: 20px;
              background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
              border: none;
              box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
            "
          >
            <i class="fa fa-save"></i> Simpan Telaahan
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Initialize Select2 specifically for the modal unit select
    $('#id_unit_modal').select2({
      placeholder: "-- Pilih Unit --",
      width: '100%',
      dropdownParent: $('#telaahanModal'),
      language: {
        inputTooShort: function() {
          return "-- Pilih Unit --";
        },
        noResults: function() {
          return "Tidak ada hasil ditemukan";
        }
      }
    });

  // $('.select2').select2({
  //   placeholder: "Pilih & Ketik minimal 3 huruf untuk mencari...",
  //   width: '100%',
  //   language: {
  //     inputTooShort: function() {
  //       return "Ketik minimal 3 huruf untuk mencari";
  //     },
  //     noResults: function() {
  //       return "Tidak ada hasil ditemukan";
  //     }
  //   }
  // });
    var table;
    if ($.fn.dataTable.isDataTable("#tabelSuratTelaahan")) {
      table = $("#tabelSuratTelaahan").DataTable();
    } else {
      table = $("#tabelSuratTelaahan").DataTable({
        pageLength: 10, // default show 10 entries
        lengthMenu: [
          [10, 25, 50, 100, -1],
          [10, 25, 50, 100, "All"],
        ],
        order: [[0, "desc"]], // tampilkan data terbaru (id terbesar) di atas
        language: {
          lengthMenu: "Tampilkan _MENU_ data per halaman",
          zeroRecords:
            "datanya kosong, anda harus pilih unit anda terlebih dahulu",
          info: "Menampilkan halaman _PAGE_ dari _PAGES_",
          infoEmpty: "Tidak ada data tersedia",
          infoFiltered: "(disaring dari total _MAX_ data)",
          search: "Cari:",
          paginate: {
            first: "Pertama",
            last: "Terakhir",
            next: "›",
            previous: "‹",
          },
        },
      });
    }

    // Filter unit: tombol "Pilih" akan submit form; perubahan select tidak auto-submit
    var checkAll = document.getElementById("checkAll");
    if (checkAll) {
      checkAll.addEventListener("change", function () {
        document
          .querySelectorAll('input[name="id_surat[]"]')
          .forEach(function (cb) {
            cb.checked = checkAll.checked;
          });
        updateTelaahanCount();
      });
    }
    // Validasi: pastikan ada checkbox terpilih sebelum submit ke cetakusulanrka.html
    const formCetak = document.getElementById("formCetakTelaahan");
    formCetak.addEventListener("submit", function (e) {
      const checked = document.querySelectorAll(
        'input[name="id_surat[]"]:checked',
      );
      if (checked.length === 0) {
        e.preventDefault();
        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "warning",
            title: "Pilih minimal satu data surat telaahan terlebih dahulu",
            timer: 2000,
            showConfirmButton: false,
          });
        } else {
          alert("Pilih minimal satu data surat telaahan terlebih dahulu");
        }
      }
    });
    // Utility notifikasi dengan fallback jika SweetAlert2 tidak tersedia
    function showNotification(type, message) {
      var iconMap = {
        success: "success",
        warning: "warning",
        danger: "error",
        error: "error",
        info: "info",
      };
      if (typeof Swal !== "undefined") {
        Swal.fire({
          icon: iconMap[type] || "info",
          title: message,
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
        });
      } else {
        // Fallback sederhana jika SweetAlert2 tidak termuat
        alert(message);
      }
    }

    // Tampilkan notifikasi berdasarkan parameter URL
    const params = new URLSearchParams(window.location.search);
    if (params.get("added") === "1") {
      showNotification("success", "Data berhasil ditambahkan!");
      // Sorot baris teratas sebagai indikasi data baru
      const firstRow = $(table.row(0).node());
      firstRow.addClass("highlight-new");
      setTimeout(() => firstRow.removeClass("highlight-new"), 2500);
    }
    if (params.get("edited") === "1") {
      showNotification("warning", "Data berhasil diperbarui!");
    }
    if (params.get("deleted") === "1") {
      showNotification("error", "Data berhasil dihapus!");
    }

    // Hapus parameter notifikasi dari URL agar tidak muncul lagi saat refresh
    if (params.has("added") || params.has("edited") || params.has("deleted")) {
      params.delete("added");
      params.delete("edited");
      params.delete("deleted");
      const newUrl =
        window.location.pathname +
        (params.toString() ? "?" + params.toString() : "");
      window.history.replaceState({}, "", newUrl);
    }

    // Fungsi untuk update jumlah surat telaahan RKA
    function updateTelaahanCount() {
      if (!table) return;
      // Gunakan count() agar menghitung jumlah baris hasil filter secara akurat
      var rowCount = table.rows({ search: "applied" }).count();
      var $counter = $("#telaahan-count");
      if ($counter.length) {
        $counter.text(rowCount);
      }
    }

    // Panggil fungsi saat tabel selesai diinisialisasi
    updateTelaahanCount();

    // Panggil fungsi setiap kali tabel digambar ulang (termasuk saat filtering, paginasi, atau search)
    table.on("draw", function () {
      updateTelaahanCount();
    });

    // Persist filter Unit agar tidak perlu memilih ulang setelah tambah/edit/hapus
    (function persistUnitFilter() {
      const storageKey = "rka:selectedUnit";
      const filterForm = document.getElementById("formFilterUnit");
      const unitSelect = document.getElementById("id_unit_modal");
      if (!filterForm || !unitSelect) return;

      // Simpan pilihan saat tombol Pilih ditekan
      filterForm.addEventListener("submit", function () {
        try {
          localStorage.setItem(storageKey, unitSelect.value || "");
        } catch (e) {}
      });

      // Jika halaman kembali tanpa parameter id_unit, terapkan otomatis dari penyimpanan
      const params = new URLSearchParams(window.location.search);
      const hasParam = params.has("id_unit_modal") && params.get("id_unit_modal") !== "";
      let saved = null;
      try {
        saved = localStorage.getItem(storageKey);
      } catch (e) {
        saved = null;
      }
      if (!hasParam && saved) {
        if ($.fn.select2) {
          $("#id_unit_modal").val(saved).trigger("change");
        } else {
          unitSelect.value = saved;
        }
        filterForm.submit();
      }
    })();

    // Edit Button Click Handler
    $("#tabelSuratTelaahan").on("click", ".edit-btn", function (e) {
      e.preventDefault();

      var rawData = $(this).attr("data-json");
      var data = null;

      if (rawData) {
        try {
          var decodedString = decodeURIComponent(escape(window.atob(rawData)));
          data = JSON.parse(decodedString);
        } catch (err) {
          console.error("Failed to parse JSON data", err);
          return;
        }
      }

      if (!data) {
          console.error("No data found for edit");
          return;
      }

      // Populate form
      $("#id_surat_input").val(data.id_surat);
      $("#no_surat").val(data.no_surat);
      $("#tgl_surat").val(data.tgl_surat);
      $("#perihal").val(data.perihal);
      $("#permasalahan").val(data.permasalahan);
      $("#pra_anggapan").val(data.pra_anggapan);
      $("#fakta").val(data.fakta);
      $("#pembahasan").val(data.pembahasan);
      $("#saran_tindakan").val(data.saran_tindakan);
      $("#penutup").val(data.penutup);

      // Select2 update
      var id_unit = data.id_unit;
      if ($("#id_unit_modal").hasClass("select2-hidden-accessible")) {
        $("#id_unit_modal").val(id_unit).trigger("change");
      } else {
        $("#id_unit_modal").val(id_unit);
      }

      // Change form action and title
      $("#telaahanForm").attr(
        "action",
        '{?=url([ADMIN, "hosplan", "updatesurattelaahan"])?}',
      );
      $("#telaahanModalTitle").html(
        '<i class="fa fa-pencil-square-o" style="color:#fff;"></i> <span style="color: #fff">Edit Surat Telaahan</span>',
      );

      // Show Modal
      $("#telaahanModal").modal("show");
    });

    // Reset Form on Modal Close
    $("#telaahanModal").on("hidden.bs.modal", function () {
      $("#telaahanForm")[0].reset();
      $("#id_surat_input").val("");
      $("#telaahanForm").attr(
        "action",
        '{?=url([ADMIN, "hosplan", "tambahsurattelaahan"])?}',
      );
      $("#telaahanModalTitle").html(
        '<i class="fa fa-pencil-square-o" style="color:#fff;"></i> <span style="color: #fff">Tambah Surat Telaahan</span>',
      );
      if ($("#id_unit_modal").hasClass("select2-hidden-accessible")) {
        $("#id_unit_modal").val("").trigger("change");
      } else {
        $("#id_unit_modal").val("");
      }
    });

    $("#tabelSuratTelaahan").on("click", ".btn-hapus", function (e) {
      e.preventDefault();
      var url = $(this).attr("href");

      if (typeof Swal !== "undefined") {
        Swal.fire({
          title: "Anda yakin?",
          text: "Data yang dihapus tidak dapat dikembalikan!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = url;
          }
        });
      } else {
        // Fallback ke konfirmasi native
        if (confirm("Yakin ingin menghapus usulan RKA ini?")) {
          window.location.href = url;
        }
      }
    });
  });
</script>
