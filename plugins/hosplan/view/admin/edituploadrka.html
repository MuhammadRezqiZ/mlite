<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
:root{--bg-soft:#f8fafc;--border-soft:#e5e7eb;--text-muted:#64748b;--primary:#0ea5e9;--primary-dark:#0284c7}
.card{border:1px solid var(--border-soft);border-radius:14px;box-shadow:0 8px 28px rgba(2,8,23,.08);overflow:hidden;background:#fff}
.card-header{background:linear-gradient(180deg,#f8fafc,#ffffff);border-bottom:1px solid var(--border-soft);padding:16px 18px}
.card-header h3{margin:0;font-weight:700;color:#0f172a}
.card-body{padding:18px}
.form-group label{font-weight:600;color:#374151;margin-bottom:6px;display:block}
.form-control{border:1px solid var(--border-soft);border-radius:10px;box-shadow:none;height:42px}
.form-control:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(14,165,233,.2)}
.select2-container{width:100% !important}
.select2-container .select2-selection--single{height:42px;border-radius:10px;border:1px solid var(--border-soft)}
.select2-container--default .select2-selection--single .select2-selection__rendered{line-height:42px;padding-left:12px}
.select2-container--default .select2-selection--single .select2-selection__arrow{height:40px}
.modal-footer{border-top:1px solid var(--border-soft);background:#fff;padding:14px}
.btn{border-radius:10px}
.btn-primary{background:var(--primary);border-color:var(--primary)}
.btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark)}
.btn-secondary{background:#6b7280;border-color:#6b7280;color:#fff}
.btn-secondary:hover{background:#4b5563;border-color:#4b5563;color:#fff}
</style>

<div class="card">
  <div class="card-header">
    <h3>Edit Upload Usulan RKA</h3>
  </div>

  <div class="card-body">
    <form action="{?=url([ADMIN, 'hosplan', 'updateuploadrka'])?}" method="post" enctype="multipart/form-data">
      <input type="hidden" id="id_usulan" name="id_usulan" value="{$uploadrka.id_usulan}">

        <div class="row">
          <div class="col-md-6 mb-3" style="margin-top: 12px;">
            <label for="id_surat">Nomor Surat</label>
            <select id="id_surat" class="form-control select2" name="id_surat" required>
              <option value="">Pilih Surat</option>
              {loop: $surat}
              <option value="{$value.id_surat}" {if: $value.id_surat == $uploadrka.id_surat}selected{/if}>{$value.no_surat}</option>
              {/loop}
            </select>
          </div>

          <div class="col-md-6 mb-3" style="margin-top: 12px;">
            <label for="id_unit">Pengirim</label>
            <select id="id_unit" class="form-control select2" name="id_unit" required>
              <option value="">Pilih Unit</option>
              {loop: $unit}
              <option value="{$value.id_unit}" {if: $value.id_unit == $uploadrka.id_unit}selected{/if}>{$value.nama_unit}</option>
              {/loop}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3" style="margin-top: 12px;">
            <label for="tanggal_usulan">Tanggal Surat</label>
            <input id="tanggal_usulan" type="date" class="form-control" name="tanggal_usulan" value="{$uploadrka.tanggal_usulan}" required>
          </div>

          <div class="col-md-4 mb-3" style="margin-top: 12px;">
            <label for="id_jenis_usulan">Jenis Usulan</label>
            <select id="id_jenis_usulan" class="form-control" name="id_jenis_usulan" required>
              <option value="">Pilih Jenis Usulan</option>
              {loop: $jenis}
              <option value="{$value.id_jenis_usulan}" {if: $value.id_jenis_usulan == $uploadrka.id_jenis_usulan}selected{/if}>{$value.jenis_usulan}</option>
              {/loop}
            </select>
          </div>
          <div class="col-md-4 mb-3" style="margin-top: 12px;">
            <label for="id_status_surat">Status Usulan</label>
            <select id="id_status_surat" class="form-control" name="id_status_surat" required>
              <option value="">Pilih Status Usulan</option>
              {loop: $status}
              <option value="{$value.id_status_surat}" {if: $value.id_status_surat == $uploadrka.id_status_surat}selected{/if}>{$value.status_surat}</option>
              {/loop}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3" style="margin-top: 12px;">
            <label for="perihal">Perihal</label>
            <input id="perihal" type="text" class="form-control" name="perihal" value="{$uploadrka.perihal}" placeholder="Masukkan Perihal" required>
          </div>
          <div class="col-md-6 mb-3" style="margin-top: 12px;">
            <label for="file_usulan">Upload File (PDF/DOC)</label>
            <input id="file_usulan" type="file" class="form-control" name="file_usulan" accept=".pdf,.doc,.docx">
            <small id="file_usulan_error" class="text-danger"></small>
            {if: !empty($uploadrka.file_usulan)}
            <small class="text-muted">File saat ini:
              {if: !empty($uploadrka.file_url)}
                <a href="{?= url($uploadrka.file_url) ?}" target="_blank" rel="noopener noreferrer">{$uploadrka.file_usulan}</a>
              {/if}
              {if: empty($uploadrka.file_url)}{$uploadrka.file_usulan}{/if}
            </small>
            {/if}
        </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-3" style="margin-top: 12px;">
                <label for="keterangan">Keterangan</label>
                <input type="text" class="form-control" id="keterangan" name="keterangan" value="{$uploadrka.keterangan}" placeholder="Masukkan Keterangan" required>
            </div>
        </div>

        <div class="modal-footer justify-content-between">
            <a href="{?=url([ADMIN, 'hosplan', 'uploadusulanrka'])?}" class="btn btn-secondary">Kembali</a>
            <button type="submit" class="btn btn-primary">Simpan</button>
        </div>

    </form>
  </div>
</div>

<script>
$(document).ready(function() {
  if ($.fn.select2) {
    $('.select2').select2({
      placeholder: 'Cari...',
      width: '100%'
    });
  }

  // Validasi ukuran file maksimal 5 MB (opsional pada edit)
  var MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
  var $fileInput = $('#file_usulan');
  var $errorEl = $('#file_usulan_error');
  var $submitBtn = $('button[type="submit"]');

  function showSizeError() {
    $errorEl.text('Ukuran file terlalu besar (maks 5 MB).');
    $submitBtn.prop('disabled', true);
  }

  function clearError() {
    $errorEl.text('');
    $submitBtn.prop('disabled', false);
  }

  $fileInput.on('change', function() {
    clearError();
    var f = this.files && this.files[0] ? this.files[0] : null;
    if (f && f.size > MAX_FILE_SIZE) {
      showSizeError();
      // Kosongkan input agar tidak ikut terkirim
      $fileInput.val('');
    }
  });

  $('form').on('submit', function(e) {
    clearError();
    var f = $fileInput[0].files && $fileInput[0].files[0] ? $fileInput[0].files[0] : null;
    if (f && f.size > MAX_FILE_SIZE) {
      e.preventDefault();
      showSizeError();
    }
  });

  // Tampilkan pesan dari server via query string ?error=size
  try {
    var params = new URLSearchParams(window.location.search);
    if (params.get('error') === 'size') {
      showSizeError();
    }
  } catch (err) {}
});
</script>