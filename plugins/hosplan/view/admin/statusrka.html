<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  .form-group label {
    font-weight: 500;
    margin-bottom: 6px;
  }
  .callout.callout-info {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
    color: #0f172a;
    border-radius: 10px;
    padding: 12px 14px;
  }
  .select2-container .select2-selection--single {
    height: 38px;
    border-radius: 6px;
    border: 1px solid #ced4da;
  }
  .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 38px;
    padding-left: 10px;
  }
  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
  }
</style>

<div class="card">
  <div class="card-header">
    <h3>Apakah Anda Yakin Konfirmasi Status Usulan RKA Ini?</h3>
    <div class="callout callout-info no-print" style="margin-top: 12px; margin-bottom: 12px;">
      <h5><i class="fa fa-info"></i> &nbsp; Catatan :</h5>
      Pastikan anda memberikan Alasan dan Keterangan saat mengonfirmasi status usulan RKA. Jika menyetujui, jelaskan alasan persetujuan; jika menolak, sertakan alasan penolakan.
    </div>
  </div>

  <div class="card-body">
    <form action="{?=url([ADMIN, 'hosplan', 'updatestatusrka'])?}" method="post" enctype="multipart/form-data">
      <input type="hidden" id="id_usulan" name="id_usulan" value="{$uploadrka.id_usulan}">

        <div class="row">
          <div class="col-md-12 mb-3" style="margin-top: 12px;">
            <label for="id_status_surat">Status Usulan</label>
            <select id="id_status_surat" class="form-control" name="id_status_surat" required>
              <option value="">Pilih Status Usulan</option>
              {loop: $status}
              <option value="{$value.id_status_surat}" {if: $value.id_status_surat == $uploadrka.id_status_surat}selected{/if}>{$value.status_surat}</option>
              {/loop}
            </select>
          </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-3" style="margin-top: 12px;">
                <label for="keterangan">Keterangan</label>
                <input type="text" class="form-control" id="keterangan" name="keterangan" value="{$uploadrka.keterangan}" placeholder="Masukkan Keterangan" required>
            </div>
        </div>

        <div class="modal-footer justify-content-between">
            <a href="{?=url([ADMIN, 'hosplan', 'konfirmasiusulanrka'])?}" class="btn btn-secondary">Kembali</a>
            <button type="submit" class="btn btn-primary">Simpan</button>
        </div>

        <div class="row">
          <div class="col-md-12 mb-3" style="margin-top: 6px;">
            <label style="margin-bottom: 6px;">Lampiran Usulan</label>
            {if: $uploadrka.file_url}
              <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;background:#fafafa">
                <div style="padding:8px 12px;background:#f3f4f6;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                  <div style="font-weight:600;color:#0f172a;">Pratinjau Lampiran</div>
                  <a href="{?= url($uploadrka.file_url) ?}" target="_blank" style="text-decoration:none">Buka di tab baru</a>
                </div>
                <iframe src="{?= url($uploadrka.file_url) ?}" style="width:100%;height:1200px;border:0" loading="lazy"></iframe>
              </div>
            {else}
              <div style="padding:10px;border:1px dashed #d1d5db;border-radius:8px;color:#6b7280;">Tidak ada lampiran yang diunggah.</div>
            {/if}
          </div>
        </div>

    </form>
  </div>
</div>

<script>
$(document).ready(function() {
  if ($.fn.select2) {
    $('.select2').select2({
      placeholder: 'Cari...',
      width: '100%'
    });
  }

  // Validasi ukuran file maksimal 5 MB (opsional pada edit)
  var MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
  var $fileInput = $('#file_usulan');
  var $errorEl = $('#file_usulan_error');
  var $submitBtn = $('button[type="submit"]');

  function showSizeError() {
    $errorEl.text('Ukuran file terlalu besar (maks 5 MB).');
    $submitBtn.prop('disabled', true);
  }

  function clearError() {
    $errorEl.text('');
    $submitBtn.prop('disabled', false);
  }

  $fileInput.on('change', function() {
    clearError();
    var f = this.files && this.files[0] ? this.files[0] : null;
    if (f && f.size > MAX_FILE_SIZE) {
      showSizeError();
      // Kosongkan input agar tidak ikut terkirim
      $fileInput.val('');
    }
  });

  $('form').on('submit', function(e) {
    clearError();
    var f = $fileInput[0].files && $fileInput[0].files[0] ? $fileInput[0].files[0] : null;
    if (f && f.size > MAX_FILE_SIZE) {
      e.preventDefault();
      showSizeError();
    }
  });

  // Tampilkan pesan dari server via query string ?error=size
  try {
    var params = new URLSearchParams(window.location.search);
    if (params.get('error') === 'size') {
      showSizeError();
    }
  } catch (err) {}
});
</script>