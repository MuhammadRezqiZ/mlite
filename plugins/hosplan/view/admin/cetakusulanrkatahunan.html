<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
  /* Style dasar area cetak */
  .print-area {
    width: 100%;
    box-sizing: border-box;
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
    font-size: 12pt;
    color: #111827;
  }
  .print-container { max-width: 1800px; margin: 0 auto; padding: 8px 16px; }
  .page-title { text-align: center; font-size: 24px; font-weight: 700; margin: 40px 0 24px; color: #0f172a; }
  .subtitle { font-size: 14px; margin-bottom: 14px; font-weight: 600; color: #374151; }
  .btn-tombol { justify-content: center; border: 0; border-radius: 8px; padding: 10px 14px; font-size: 14px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,.08); }
  .btn-tombol:hover { background: #1f2937; }
  /* Penyesuaian ukuran tombol-tombol agar seragam dengan tombol kecil */
  .card.card-default .card-footer .btn-tombol { padding: 8px 12px; }
  .print-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); padding: 16px; }
  /* Modernisasi kartu form dan kontrol */
  .card.card-default.no-print { border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
  .card.card-default .card-header { background: #f9fafb; border-bottom: 1px solid #e5e7eb; padding: 12px 16px; }
  .card.card-default .card-title { font-weight: 600; color: #0f172a; margin: 0; }
  .card.card-default .card-body { padding: 16px; }
  .card.card-default .card-footer { background: transparent; border-top: 0; padding: 12px 16px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; }
  .card.card-default .form-group label { font-weight: 600; color: #374151; margin-bottom: 6px; }
  .card.card-default .form-control { border-radius: 10px; border: 1px solid #d1d5db; padding: 8px 12px; transition: border-color .15s ease, box-shadow .15s ease; }
  .card.card-default .form-control:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.15); outline: none; }
  .callout.callout-info { background: #eff6ff; border-left: 4px solid #3b82f6; color: #0f172a; border-radius: 10px; padding: 12px 14px; }
  .btn-primary.btn-sm { border-radius: 8px; }
  .rka-table { width: 100%; border-collapse: separate; border-spacing: 1; }
  .rka-table thead th { background: #f3f4f6; color: #111827; font-weight: 600; border-bottom: 0px solid #e5e7eb; padding: 10px; text-align: center; }
  .rka-table tbody td { border-top: 0px solid #e5e7eb; padding: 1px; vertical-align: top; }
  .rka-table th, .rka-table td { padding: 8px 12px !important; }

  .rka-table tbody tr:nth-child(odd) { background: #fafafa; }
  .text-right { text-align: right; }
  .text-center { text-align: center; }
  @media print {
    /* Kertas A4 portrait dengan margin nyaman */
    @page { size: A4 landscape; margin: 15mm; }

    /* Hilangkan margin/padding default di html & body agar kop naik */
    html, body { margin: 0 !important; padding: 0 !important; }

    /* Sembunyikan elemen non-print (navbar, footer, dll) */
    .no-print,
    .sidebar,
    .navbar,
    #navbar-wrapper,
    nav.navbar,
    .footer,
    .main-header,
    .main-sidebar,
    .control-sidebar,
    .brand-link,
    .content-header,
    .content-title,
    .icon-bar,
    #notify,
    .dropdown-menu,
    .main-footer,
    footer { display: none !important; }

    /* Biarkan area surat tampil normal dan gunakan font serif untuk cetak */
    .print-area { position: static; width: 100%; font-family: 'Times New Roman', Times, serif; color: #000; }
    .print-container { max-width: none !important; padding: 0 !important; }
    .print-card { box-shadow: none !important; border: 0 !important; border-radius: 0 !important; padding: 0 !important; }

    /* Tabel cetak klasik: garis tebal hitam, tanpa zebra */
    .text-uraian { font-size: 14px; font-weight: 400; color: #000; }
    .text-nama { font-size: 14px; font-weight: 400; color: #000; }
    .text-spesifikasi { font-size: 14px; font-weight: 400; color: #000; }
    .text-merek { font-size: 14px; font-weight: 160; color: #000; }
    .text-volume { font-size: 14px; font-weight: 160; color: #000; }
    .text-satuan { font-size: 14px; font-weight: 160; color: #000; }
    .text-harga { font-size: 14px; font-weight: 240; color: #000; }
    .text-jumlah { font-size: 14px; font-weight: 240; color: #000; }
    .text-unit { font-size: 14px; font-weight: 240; color: #000; }
    .text-keterangan { font-size: 14px; font-weight: 400; color: #000; }
    table.rka-table { width: 1400px !important; border-collapse: collapse !important; border: 1px solid #000 !important; }
    .rka-table thead th { background: #fff !important; color: #000 !important; text-align: center !important; border: 1px solid #000 !important; }
    .rka-table tbody td { background: #fff !important; color: #000 !important; border: 1px solid #000 !important; }
    .rka-table tbody tr:nth-child(odd) { background: #fff !important; }
    /* Beri jarak antara isi dan garis saat cetak */
  .rka-table th, .rka-table td { padding: 8px 12px !important; }

  /* Judul lebih besar saat cetak */
  .page-title { font-size: 28px !important; color: #000 !important; margin: 0 0 12mm !important; }

  /* Sembunyikan tombol aksi saat cetak */
  .btn-print { display: none !important; }
  .subtitle { color: #000 !important; }

  /* Matikan penambahan URL otomatis di belakang tautan saat print */
  a[href]:after, abbr[title]:after { content: '' !important; }
  }
  /* Modal TTD */
  .custom-modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
  .custom-modal-content { background:#fff; margin:10% auto; padding:20px; border:1px solid #888; width:80%; max-width:600px; border-radius:8px; text-align:center; }
  .close-modal { float:right; font-size:28px; font-weight:bold; cursor:pointer; color:#999; }
  .close-modal:hover { color:#000; }
  .ttd-grid { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px; }
  .ttd-item { border:1px solid #ddd; padding:10px; border-radius:4px; cursor:pointer; transition:transform .2s, border-color .2s; }
  .ttd-item:hover { transform:scale(1.05); border-color:#007bff; }
  .ttd-item img { max-width:150px; max-height:100px; display:block; margin:0 auto; }
  /* Tampilan TTD pada area tanda tangan */
  .signature #ttd-image-container { min-height:110px; display:flex; align-items:center; justify-content:center; }
  .signature #ttd-image-container img.ttd-img { max-height:110px; width:auto; image-rendering:-webkit-optimize-contrast; }
  @media print {
    .signature #ttd-image-container img.ttd-img { max-height:110px; }
  }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed">
<div class="wrapper">
  <div class="content-wrapper">
    <section class="content" >
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 print-container">
            <div class="callout callout-info no-print" style="margin-bottom: 20px;">
              <h5><i class="fa fa-info"></i> &nbsp; Catatan :</h5>
               Pastikan anda telah menginput semua inputan Surat Usulan RKA terlebih dulu sebelum menekan tombol üñ®Ô∏è Print/Simpan pdf.
            </div>
            <div class="card card-default no-print" style="margin-bottom: 20px;">
              <div class="card-header">
                <h3 class="card-title">Input Surat Usulan RKA Tahunan</h3>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="tanggal_cetak">Tanggal :</label>
                      <input type="date" id="tanggal_cetak" class="form-control">
                    </div>
                    
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="unit_cetak">Dari Unit :</label>
                      <select id="unit_cetak" value="" class="form-control select2">
                        <option value="">Pilih Unit</option>
                        {loop: $unit}
                          <option value="{$value.id_unit}" 
                                  data-nama="{$value.nama_unit}"
                                  data-pegawai="{$value.nama_pegawai}"
                                  data-nip="{$value.nip}"
                                  >{$value.nama_unit}
                          </option>
                        {/loop}
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6" hidden>
                    <div class="form-group">
                      <label for="nama_pegawai">Nama Pegawai :</label>
                      <input type="text" id="nama_pegawai" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                      <label for="nip_pegawai">NIP :</label>
                      <input type="text" id="nip_pegawai" class="form-control" readonly>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <button id="btnTerapkanCetak" class="btn-tombol btn-info btn-sm" style="background:#0743c5;color:#fff;">Terapkan</button>
                <button id="btn-sign" class="btn-tombol btn-print no-print" style="background:#28a745;color:#fff;">‚úçÔ∏è TTD-Elektronik</button>
                <button class="btn-tombol btn-print no-print" onclick="window.print()" style="background:#111827;color:#fff;">üñ®Ô∏è Print / Simpan PDF</button>
                <button class="btn-tombol no-print" onclick="window.excel()" style="background:#0c7511;color:#fff;">üìù Excel</button>
                <a href="{?=url([ADMIN, 'hosplan', 'usulanrkatahunan'])?}" class="btn-tombol btn-secondary no-print" style="background:#dc0404;color:#fff;">Kembali</a>
              </div>
            </div>
            <!-- Main content -->
            <div class="print-area">
              <!-- title row -->
              <div class="row">
                <div class="col-12">
                  <h1 class="page-title"><strong>Rincian Rencana Kerja Anggaran Tahun 2026</strong></h1>
                  <div class="subtitle"><strong>Bidang/Instalasi/Unit/Ruangan :</strong> &nbsp;<span id="unit_area1"> - </div>
                  <div class="print-card">
                    <table class="rka-table">
                      <thead>
                        <tr>
                          <th class="text-uraian" style="text-align: center;">Uraian Kegiatan</th>
                          <th class="text-nama" style="text-align: center;">Nama Komponen</th>
                          <th class="text-spesifikasi" style="text-align: center;">Spesifikasi</th>
                          <th class="text-merek" style="text-align: center;">Merek</th>
                          <th class="text-volume" style="text-align: center;">Volume</th>
                          <th class="text-satuan" style="text-align: center;">Satuan</th>
                          <th class="text-harga" style="text-align: center;">Harga</th>
                          <th class="text-jumlah" style="text-align: center;">Jumlah</th>
                          <th class="text-unit" style="text-align: center;">Unit</th>
                          <th class="text-keterangan" style="text-align: center;">Keterangan</th>
                        </tr>
                      </thead>
                      <tbody>
                        {loop: $usulanrkatahunan}
                        <tr>
                          <td class="text-uraian" style="text-align: left;">{$value.uraian_akun}</td>
                          <td class="text-nama" style="text-align: center;">{$value.nama_komponen}</td>
                          <td class="text-spesifikasi" style="text-align: center;">{$value.spesifikasi}</td>
                          <td class="text-merek" style="text-align: center;">{$value.merek}</td>
                          <td class="text-volume" style="text-align: center;">{$value.volume}</td>
                          <td class="text-satuan" style="text-align: center;">{$value.nama_satuan}</td>
                          <td class="text-harga" style="text-align: left;">Rp. {?=number_format($value['harga'], 0, ',', '.')?}</td>
                          <td class="text-jumlah" style="text-align: left;">Rp. {?=number_format($value['jumlah'], 0, ',', '.')?}</td>
                          <td class="text-unit" style="text-align: center;">{$value.nama_unit}</td>
                          <td class="text-keterangan" style="text-align: center;">{$value.keterangan}</td>
                        </tr>
                        {/loop}
                      </tbody>
                    </table>
                  </div>
                    <div class="signature" style="width: 320px; float: right; margin-top: 50px; text-align: center; font-size: 14px;">
                      <div>Barabai, <span id="tanggal_area"></span> </div>
                      <div class="">Kepala <span id="unit_area2">-</div>
                      
                      <!-- Ruang tanda tangan -->
                      <div id="ttd-image-container" style="margin-top: 6px;"></div>

                      <div class="name" style="margin-top: 1px; font-weight: 700;"><span id="pegawai_area" style="text-decoration: underline;">-</div>
                      <div style="font-size: 14px"><span id="nip_area">-</div>
                    </div>
                </div>
                <!-- /.col -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
<!-- Modal Pilihan TTD -->
<div id="ttdModal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="close-modal">&times;</span>
    <h3>Pilih Tanda Tangan</h3>
    <div class="ttd-grid">
      {loop: $ttd_files}
        <div class="ttd-item" data-src="{?= url('plugins/hosplan/img/ttd/'.$value) ?}">
          <img src="{?= url('plugins/hosplan/img/ttd/'.$value) ?}" alt="{$value}">
          <p style="margin-top:5px;font-size:12px;">{$value}</p>
        </div>
      {/loop}
    </div>
  </div>
</div>
<script>
  if (window.jQuery && typeof $.fn.select2 === 'function') {
    $('.select2').select2({
      placeholder: "Ketik minimal 3 huruf untuk mencari...",
      width: '100%',
      language: {
        inputTooShort: function() {
          return "Ketik minimal 3 huruf untuk mencari";
        },
        noResults: function() {
          return "Tidak ada hasil ditemukan";
        }
      }
    });
  }
  const checkAllEl = document.getElementById('checkAll');
  if (checkAllEl) {
    checkAllEl.addEventListener('change', function() {
      document.querySelectorAll('input[name="id_usulan[]"]').forEach(cb => cb.checked = this.checked);
    });
  }
  document.getElementById('btnTerapkanCetak').addEventListener('click', function() {
    const tanggalInput = document.getElementById('tanggal_cetak').value;
    const unitSelect = document.getElementById('unit_cetak');
    const unitInput = unitSelect && unitSelect.selectedIndex >= 0
      ? (unitSelect.options[unitSelect.selectedIndex].getAttribute('data-nama') || '')
      : '';
    // Ambil nilai yang diketik manual jika ada
    const namaPegawaiInput = (document.getElementById('nama_pegawai').value || '').trim();
    const nipPegawaiInput = (document.getElementById('nip_pegawai').value || '').trim();
    // Fallback ke data atribut dari option bila input kosong
    const namaPegawaiOption = unitSelect && unitSelect.selectedIndex >= 0
      ? (unitSelect.options[unitSelect.selectedIndex].getAttribute('data-pegawai') || '')
      : '';
    const nipPegawaiOption = unitSelect && unitSelect.selectedIndex >= 0
      ? (unitSelect.options[unitSelect.selectedIndex].getAttribute('data-nip') || '')
      : '';

    const namaFinal = namaPegawaiInput || namaPegawaiOption;
    const nipFinal = nipPegawaiInput || nipPegawaiOption;

    if (tanggalInput) {
      const tanggalBaru = new Date(tanggalInput);
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      let formatTanggal = tanggalBaru.toLocaleDateString('id-ID', options);
      formatTanggal = formatTanggal.replace(/(\s[a-z])/, function(m) { return m.toUpperCase(); });

      // Tampilkan tanggal saja pada span; teks "Barabai," sudah ada di markup
      document.getElementById('tanggal_area').innerText = formatTanggal;
    }
    document.getElementById('unit_area1').innerText = unitInput || '-';
    document.getElementById('unit_area2').innerText = unitInput || '-';
    document.getElementById('pegawai_area').innerText = namaFinal || '-';
    document.getElementById('nip_area').innerText = nipFinal ? `NIP. ${nipFinal}` : '-';
  });

  // Autofill nama dan NIP saat unit dipilih
  const unitCetakEl = document.getElementById('unit_cetak');
  if (unitCetakEl) {
    function fillFromSelectedOption(sel) {
      if (!sel) return;
      const namaPegawai = sel.getAttribute('data-pegawai') || '';
      const nipPegawai = sel.getAttribute('data-nip') || '';
      document.getElementById('nama_pegawai').value = namaPegawai;
      document.getElementById('nip_pegawai').value = nipPegawai;
      // Sekaligus update area tanda tangan agar sinkron
      document.getElementById('pegawai_area').innerText = namaPegawai || '-';
      document.getElementById('nip_area').innerText = nipPegawai ? `NIP. ${nipPegawai}` : '-';
      // Update nama unit di header
      const unitName = sel.getAttribute('data-nama') || sel.textContent || '';
      document.getElementById('unit_area1').innerText = unitName || '-';
      document.getElementById('unit_area2').innerText = unitName || '-';
    }

    unitCetakEl.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      fillFromSelectedOption(selected);
    });

    // Jika Select2 aktif, pastikan event spesifiknya juga memicu autofill
    if (window.jQuery && typeof $.fn.select2 === 'function') {
      $('#unit_cetak').on('select2:select', function(e) {
        const idx = unitCetakEl.selectedIndex;
        const selected = unitCetakEl.options[idx];
        fillFromSelectedOption(selected);
      });
      $('#unit_cetak').on('select2:clear', function() {
        document.getElementById('nama_pegawai').value = '';
        document.getElementById('nip_pegawai').value = '';
        document.getElementById('pegawai_area').innerText = '-';
        document.getElementById('nip_area').innerText = '-';
        document.getElementById('unit_area1').innerText = '-';
        document.getElementById('unit_area2').innerText = '-';
      });
    }
  }
  // Export ke Excel untuk RKA
  window.excel = function(){
    try {
      var table = document.querySelector('.rka-table');
      if (!table) { alert('Tabel RKA tidak ditemukan'); return; }

      function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      var judul = (document.querySelector('.page-title') && document.querySelector('.page-title').textContent) || 'Rincian Rencana Kerja Anggaran';
      var unit = (document.getElementById('unit_area1') && document.getElementById('unit_area1').textContent) || '-';
      var tanggal = (document.getElementById('tanggal_area') && document.getElementById('tanggal_area').textContent) || '';
      var pegawai = (document.getElementById('pegawai_area') && document.getElementById('pegawai_area').textContent) || '';
      var nip = (document.getElementById('nip_area') && document.getElementById('nip_area').textContent) || '';

      var cell = 'style="border:0.5pt solid #000;padding:3px 5px"';
      var cellCenter = 'style="border:0.5pt solid #000;padding:3px 5px;text-align:center"';
      var cellRight = 'style="border:0.5pt solid #000;padding:3px 5px;text-align:right"';

      var title = '<tr><th colspan="10" style="text-align:center;border:none;font-size:16px">'+esc(judul)+'</th></tr>'+
                  '<tr><td colspan="10" style="border:none">Bidang/Instalasi/Unit/Ruangan : '+esc(unit)+'</td></tr>'+
                  '<tr><td colspan="10" style="height:6px;border:none"></td></tr>';

      var theadCells = table.tHead ? Array.from(table.tHead.rows[0].cells).map(function(th){ return '<th '+cellCenter+'>'+esc(th.textContent||'')+'</th>'; }).join('') : '';
      var thead = '<tr>'+ theadCells +'</tr>';

      var tbody = '';
      if (table.tBodies && table.tBodies.length) {
        var rows = table.tBodies[0].rows;
        for (var i=0;i<rows.length;i++){
          var tds = rows[i].cells;
          tbody += '<tr>'+
            '<td '+cell+'>'+esc(tds[0] ? tds[0].textContent : '')+'</td>'+
            '<td '+cell+'>'+esc(tds[1] ? tds[1].textContent : '')+'</td>'+
            '<td '+cell+'>'+esc(tds[2] ? tds[2].textContent : '')+'</td>'+
            '<td '+cell+'>'+esc(tds[3] ? tds[3].textContent : '')+'</td>'+
            '<td '+cellCenter+'>'+esc(tds[4] ? tds[4].textContent : '')+'</td>'+
            '<td '+cellCenter+'>'+esc(tds[5] ? tds[5].textContent : '')+'</td>'+
            '<td '+cellRight+'>'+esc(tds[6] ? tds[6].textContent : '')+'</td>'+
            '<td '+cellRight+'>'+esc(tds[7] ? tds[7].textContent : '')+'</td>'+
            '<td '+cellCenter+'>'+esc(tds[8] ? tds[8].textContent : '')+'</td>'+
            '<td '+cell+'>'+esc(tds[9] ? tds[9].textContent : '')+'</td>'+
          '</tr>';
        }
      }

      var footer = '<tr><td colspan="10" style="height:18px;border:none"></td></tr>'+
                   '<tr><td colspan="10" style="text-align:right;border:none">Barabai, '+esc(tanggal||'')+'</td></tr>'+
                   '<tr><td colspan="10" style="text-align:right;border:none">Kepala '+esc(unit)+'</td></tr>'+
                   '<tr><td colspan="10" style="height:40px;border:none"></td></tr>'+
                   '<tr><td colspan="10" style="text-align:right;border:none"><u>'+esc(pegawai||'-')+'</u></td></tr>'+
                   '<tr><td colspan="10" style="text-align:right;border:none">'+esc(nip||'-')+'</td></tr>';

      var xls = '<html><head><meta charset="UTF-8"></head><body>'+
                '<table border="0" style="border-collapse:collapse;border:none;width:100%">' +
                title + thead + tbody + footer +
                '</table></body></html>';

      var blob = new Blob([xls], {type: 'application/vnd.ms-excel'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      var d = new Date();
      a.download = 'rka_'+ d.getFullYear() + '-' + (('0'+(d.getMonth()+1)).slice(-2)) + '-' + (('0'+d.getDate()).slice(-2)) + '.xls';
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); document.body.removeChild(a); }, 0);
    } catch(err) {
      alert('Gagal mengekspor ke Excel: ' + err);
    }
  };

  // Modal TTD logic
  (function(){
    var modal = document.getElementById('ttdModal');
    var btn = document.getElementById('btn-sign');
    var closeBtn = modal ? modal.querySelector('.close-modal') : null;
    if (btn && modal) {
      btn.addEventListener('click', function(){ modal.style.display = 'block'; });
    }
    if (closeBtn) {
      closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
    }
    window.addEventListener('click', function(e){
      if (e.target === modal) { modal.style.display = 'none'; }
    });
    if (modal) {
      var items = modal.querySelectorAll('.ttd-item');
      for (var i=0;i<items.length;i++){
        items[i].addEventListener('click', function(){
          var src = this.getAttribute('data-src');
          if (!src) return;
          document.getElementById('ttd-image-container').innerHTML = '<img class="ttd-img" src="'+src+'" alt="TTD">';
          modal.style.display = 'none';
          if (btn) btn.style.display = 'none';
        });
      }
    }
  })();
</script>
</body>
</html>
